<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Model description · AGNI</title><meta name="title" content="Model description · AGNI"/><meta property="og:title" content="Model description · AGNI"/><meta property="twitter:title" content="Model description · AGNI"/><meta name="description" content="Documentation for AGNI."/><meta property="og:description" content="Documentation for AGNI."/><meta property="twitter:description" content="Documentation for AGNI."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="../assets/style.css" rel="stylesheet" type="text/css"/><link href="../assets/logo.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="AGNI logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">AGNI</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li class="is-active"><a class="tocitem" href>Model description</a><ul class="internal"><li><a class="tocitem" href="#Height-structure"><span>Height structure</span></a></li><li><a class="tocitem" href="#Radiative-transfer"><span>Radiative transfer</span></a></li><li><a class="tocitem" href="#Convection"><span>Convection</span></a></li><li><a class="tocitem" href="#Phase-change"><span>Phase change</span></a></li><li><a class="tocitem" href="#Stellar-flux"><span>Stellar flux</span></a></li><li><a class="tocitem" href="#Equilibrium-chemistry"><span>Equilibrium chemistry</span></a></li><li><a class="tocitem" href="#Transparent-atmospheres"><span>Transparent atmospheres</span></a></li><li><a class="tocitem" href="#Obtaining-a-solution"><span>Obtaining a solution</span></a></li><li><a class="tocitem" href="#Other-features"><span>Other features</span></a></li><li><a class="tocitem" href="#Julia-and-Fortran"><span>Julia and Fortran</span></a></li></ul></li><li><a class="tocitem" href="../setup/">Getting started</a></li><li><a class="tocitem" href="../usage/">Using the model</a></li><li><a class="tocitem" href="../examples/">Example outputs</a></li><li><a class="tocitem" href="../troubleshooting/">Troubleshooting</a></li><li><a class="tocitem" href="../manual/">Software manual</a></li><li><a class="tocitem" href="../ecosystem/">Related codes</a></li><li><a class="tocitem" href="../contributors/">Contributors</a></li><li><a class="tocitem" href="../contributing/">Contributing</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Model description</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Model description</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/nichollsh/AGNI" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/nichollsh/AGNI/blob/main/docs/src/model/index.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Model-description"><a class="docs-heading-anchor" href="#Model-description">Model description</a><a id="Model-description-1"></a><a class="docs-heading-anchor-permalink" href="#Model-description" title="Permalink"></a></h1><p>AGNI models a planetary atmosphere by treating it as a single column (1D) and splitting it up into levels of finite thickness. These levels are defined in pressure-space, and are arranged logarithmically between the surface and the top of the atmosphere. The atmosphere is assumed to be plane-parallel. Quantities such as pressure and temperature are calculated at level-centres and level-edges, while energy fluxes are calculated only at the edges, and thermodynamic properties (e.g. heat capacity) are calculated only at their centres.</p><h2 id="Height-structure"><a class="docs-heading-anchor" href="#Height-structure">Height structure</a><a id="Height-structure-1"></a><a class="docs-heading-anchor-permalink" href="#Height-structure" title="Permalink"></a></h2><p>The atmosphere is assumed to be hydrostatically supported. The density of the gas mixture is calculated using using Amagat&#39;s additive volume law to combine the densities of the components. The densities of each gas component are nominally calculated using the Van der Walls equation of state (EOS). <a href="https://doi.org/10.1051/0004-6361/202038367">AQUA</a> is implemented as the EOS for water. The Chabrier+<a href="https://iopscience.iop.org/article/10.3847/1538-4357/aaf99f">2019</a> EOS is implemented as the EOS for hydrogen. AGNI will fallback to the ideal gas EOS for otherwise unsupported gases.</p><p>The height at each pressure level is obtained by integrating from the surface upwards using a fourth order Runge-Kutta method. This includes self-gravitational attraction, and makes AGNI applicable as an atmospheric structure model.</p><h2 id="Radiative-transfer"><a class="docs-heading-anchor" href="#Radiative-transfer">Radiative transfer</a><a id="Radiative-transfer-1"></a><a class="docs-heading-anchor-permalink" href="#Radiative-transfer" title="Permalink"></a></h2><p>Radiative transfer (RT) refers to the transport of radiation energy through a medium subject to the characteristics of the medium. Radiation passing through an atmosphere is absorbed, emitted, scattered, and reflected. In the context of planetary atmospheres, we also have to handle their surfaces, cloud formation, and radiation from the host star.</p><p>AGNI nominally simulates RT using SOCRATES, a numerical code written by the UK Met Office which solves the RT equation using a two-stream solution. SOCRATES is accessed using a Julia interface originally written by Stuart Daines. Opacity is handled using the correlated-k approximation, with either random overlap or equivalent extinction used to account for overlapping absorption in mixtures of gases.</p><p>The model uses k-terms fitted to spectral absorption cross-section data from <a href="https://dace.unige.ch/opacityDatabase/?#">DACE</a>. The MT_CKD model is used to estimate water continuum absorption cross-sections. Other continuua are derived from the HITRAN tables. Rayleigh scattering and water cloud radiative properties are also included. You can find tools for fitting k-terms and processing line absorption data in my redistribution of <a href="https://github.com/nichollsh/SOCRATES">SOCRATES</a> on GitHub. The flowchart below outlines how these absorption data are converted into a &#39;spectral file&#39;.</p>  <img src="assets/spectral_flowchart.svg" width=100% class="center"/><p>Surface reflectivity can be modelled as a greybody with an albedo from 0 to 1. Alternatively, the surface can be modelled using empirical reflectance data that varies (spectrally) with wavelength. In the latter case a filepath must be provided via the config. The file can tabulate any one of: spherical reflectance (&#39;r&#39;), hemispherical emissivity (&#39;e&#39;), or single scattering albedo (&#39;w&#39;). These data are compiled on Zenodo <a href="https://zenodo.org/communities/proteus_framework/records?q&amp;f=subject%3Asurface_albedos&amp;l=list&amp;p=1&amp;s=10&amp;sort=newest">here</a>.</p><p>AGNI also includes an interface to the <a href="https://eodg.atm.ox.ac.uk/RFM/">Reference Forward Model</a>, which is packaged as a binary blob (the RFM source code is proprietary). This interface provides an extremely easy way to validate and benchmark SOCRATES.</p><h2 id="Convection"><a class="docs-heading-anchor" href="#Convection">Convection</a><a id="Convection-1"></a><a class="docs-heading-anchor-permalink" href="#Convection" title="Permalink"></a></h2><p>Convection is a turbulent process that occurs across more than one spatial dimension, so it must be parameterised within 1D models like AGNI. In fact, it is typically parameterised inside 3D global circulation models, as resolving convection is numerically expensive. AGNI uses mixing length theory (MLT) to parameterise atmospheric convection. This is in contrast to convective adjustment, which forcibly adjusts a convectively unstable region of the atmosphere to the corresponding adiabat while ensuring that enthalpy is conserved.</p><p>MLT directly calculates the energy flux associated with convective heat transport, and thus is the preferred parameterisation within the model. It assumes that parcels of gas are diffused over a characteristic <em>mixing length</em>, transporting energy in the process. This requires choosing a scale for this mixing length, but in practice this has very little impact on the results from the model.</p><p>When evaluating convective energy fluxes, AGNI first calculates the temperature gradient across each layer of the atmosphere. Convection occurs within each layer that has a lapse rate <span>$dT/dP$</span> greater than the critical lapse rate for triggering convection. Equations 2 to 6 of Nicholls+<a href="https://academic.oup.com/mnras/article/536/3/2957/7926963">2025</a> describe the calculation of the convective energy flux under the Schwarzschild criterion. AGNI can also check against the Ledoux criterion for convective stability, which accounts for vertical gradients in the gas MMW. The atmosphere is not explicitly split into convecting and non-convecting regions, thereby allowing disconnected regions of convection.</p><h2 id="Phase-change"><a class="docs-heading-anchor" href="#Phase-change">Phase change</a><a id="Phase-change-1"></a><a class="docs-heading-anchor-permalink" href="#Phase-change" title="Permalink"></a></h2><p>Gases release energy (&quot;latent heat&quot; or &quot;enthalpy&quot;) into their surroundings when condensing into a liquid or solid. This is included in the model through a diffusive condensation scheme, which assumes a fixed condensation timescale. This takes place as follows... firstly, the mixing ratios of the gases are updated according to the temperature profile, where rainout occurs at each level until all condensables are saturated or sub-saturated. The mixing ratios of dry species are increased in order to satisfy the total pressure at condensing levels. The total accumulated amount of condensation (for each volatile) is then re-evaporated in the deeper atmosphere where possible. Any rain which is not re-evaporated before reaching the surface is considered to form an ocean. The heat released associated with the change in partial pressure of condensable gases is used to calculate a latent heating rate at each level (positive where condensing, negative where evaporating). The heating rates in each layer are then integrated (from the TOA downwards) to provide a latent heat transport <em>flux</em> at cell-edges, which the assumption being that condensation occurs by updrafts. The integrated condensable heat flux is balanced by evaporation at deeper layers which closes the energy balance.</p><p>Latent heats are temperature-dependent, using values derived from Coker (2007) and Wagner &amp; Pruß (<a href="https://doi.org/10.1063/1.1461829">2001</a>). Heat capacities are also temperature-dependent, using values derived from the JANAF database. See the <a href="https://github.com/nichollsh/ThermoTools">ThermoTools repo</a> for scripts.</p><p>This method is conceptually similar to Derras-Chouk+<a href="https://arxiv.org/abs/2508.16750">2025</a>.</p><h2 id="Stellar-flux"><a class="docs-heading-anchor" href="#Stellar-flux">Stellar flux</a><a id="Stellar-flux-1"></a><a class="docs-heading-anchor-permalink" href="#Stellar-flux" title="Permalink"></a></h2><p>A key input to the radiation model is the shortwave downward-directed flux from the star at the top of the atmosphere. This is quantified by the bolometric instellation flux, a scale factor, an artificial additional albedo factor, and a zenith angle. All of these may be provided to the model through the configuration file. The model also requires a stellar spectrum scaled to the top of the atmosphere.</p><h2 id="Equilibrium-chemistry"><a class="docs-heading-anchor" href="#Equilibrium-chemistry">Equilibrium chemistry</a><a id="Equilibrium-chemistry-1"></a><a class="docs-heading-anchor-permalink" href="#Equilibrium-chemistry" title="Permalink"></a></h2><p>By default, AGNI assumes that the atmosphere composition is &quot;well-mixed&quot;. This means that the mixing ratios of the species are constant with height. Condensation of a super-saturated volatile will reduce its mixing ratio such that it becomes exactly saturated.</p><p>With condensation turned off, AGNI can couple to <a href="https://newstrangeworlds.github.io/FastChem/">FastChem</a> - a fast numerical model of equilibrium gas-phase chemistry. FastChem takes metallicities (elemental ratios), pressures, and temperatures as input variables. It outputs the partial pressures of a wide range of volatile species, with their mixing ratios set by the equilibrium of their collective thermochemical reactions.</p><p>AGNI uses the inputted gas partial pressures (or mixing ratios) to calculate the atmosphere&#39;s metallicity. When the configuration variable <code>composition.chemistry</code> is set to a value of 1, 2, or 3 FastChem will be enabled. At each step of the solver loop, the metallicity and T-P profile will be provided to FastChem in order to calculate the atmospheric composition at each layer. This new composition is applied when calculating energy fluxes, emission spectra, etc.</p><h2 id="Transparent-atmospheres"><a class="docs-heading-anchor" href="#Transparent-atmospheres">Transparent atmospheres</a><a id="Transparent-atmospheres-1"></a><a class="docs-heading-anchor-permalink" href="#Transparent-atmospheres" title="Permalink"></a></h2><p>It is useful to run AGNI with a transparent atmosphere in various scenarios. For example, in the calculation of reflectance or emission spectra of &#39;bare rock&#39; planets. Or alternatively to determine a planet&#39;s surface temperature in the absence of an overlying atmosphere. AGNI incorporates this functionality through the configuration variable <code>composition.transparent=true</code>. This will set the atmosphere surface pressure to be small and disable the gas opacity, continuum opacity, and other absorption processes in SOCRATES.</p><p>When this is enabled, make sure to use the &quot;transparent&quot; solver. The section below does not apply in this case, as there is only one variable (the surface temperature) to solve for - this is done using a Golden-Section search method.</p><h2 id="Obtaining-a-solution"><a class="docs-heading-anchor" href="#Obtaining-a-solution">Obtaining a solution</a><a id="Obtaining-a-solution-1"></a><a class="docs-heading-anchor-permalink" href="#Obtaining-a-solution" title="Permalink"></a></h2><h3 id="Summary"><a class="docs-heading-anchor" href="#Summary">Summary</a><a id="Summary-1"></a><a class="docs-heading-anchor-permalink" href="#Summary" title="Permalink"></a></h3><p>AGNI is designed for modelling planetary atmospheres with high surface pressures and temperatures. This means that the radiative timescale differs by several orders of magnitude across the column, which makes obtaining a solution difficult. To obtain a temperature structure solution that conserves energy more precisely than a time-stepping method, AGNI solves for the temperature structure of the atmosphere as an optimisation problem. This finds the state which conserves energy across all levels and satisfies the required configuration from the user.</p><h3 id="Solution-types"><a class="docs-heading-anchor" href="#Solution-types">Solution types</a><a id="Solution-types-1"></a><a class="docs-heading-anchor-permalink" href="#Solution-types" title="Permalink"></a></h3><p>It is necessary to tell AGNI what kind of atmospheric solution to solve for. There are currently a few options available set by the <code>solution_type</code> variable in the configuration file.</p><ul><li>(1) Aim to conserve energy fluxes throughout the column. The surface temperature is fixed.</li><li>(2) Aim to conserve energy fluxes throughout the column. The surface temperature is set by energy transport through a solid conductive boundary layer of thickness <span>$d$</span> such that <span>$T_s = T_m - \frac{Fd}{k}$</span>, where <span>$T_m$</span> is the mantle temperature and <span>$k$</span> is the thermal conductivity.</li><li>(3) Solve for a state such that the flux carried at each level is equal to <span>$F_\text{int} = \sigma T_\text{int}^4$</span>, representing the rate at which a planet is losing energy into space.</li></ul><p>Solution type (1) enforces a fixed surface temperature and instellation, allowing all other temperatures and <span>$F_\text{int}$</span> to be solved-for as dependent variables. This could be used to model a young planet far from &#39;radiative equilibrium&#39; (or &#39;global energy balance&#39;) where its surface temperature is very large and the outgoing energy flux is non-zero.</p><p>Solution type (2) is appropriate for coupling with magma ocean model, where a conductive skin of solidified rock forms at the atmosphere-mantle interface. This skin is a kind of boundary layer that must be parameterised as having a particular thickness and thermal conductivity. It&#39;s thought that these layers are important for regulating the energy budget of young rocky planets. This is similar to type (1) except that <span>$T_s$</span> is allowed to change and <span>$T_m$</span> is fixed.</p><p>Solution type (3) is comparable to the implementation inside other atmosphere climate models: the surface temperature is free to change along with the rest of the atmosphere, and AGNI solves for a state of radiative equilibrium.</p><h3 id="Construction"><a class="docs-heading-anchor" href="#Construction">Construction</a><a id="Construction-1"></a><a class="docs-heading-anchor-permalink" href="#Construction" title="Permalink"></a></h3><p>The atmosphere is constructed of <span>$N$</span> levels (cell-centres), corresponding to <span>$N+1$</span> interfaces (cell-edges). The RT model takes cell-centre temperatures <span>$T_i$</span>, pressures <span>$p_i$</span>, geometric heights, and mixing ratios as input variables at each level <span>$i$</span>, as well as the surface temperature and incoming stellar flux. In return, it provides cell-edges spectral fluxes <span>$F_i$</span> at all <span>$N+1$</span> interfaces for LW &amp; SW components and upward &amp; downward streams. Convective fluxes can be estimated using the MLT scheme, condensation fluxes from the condensation scheme, and sensible heat from a simple turbulent kinetic energy (TKE) approximation (see Pierrehumbert+<a href="https://geosci.uchicago.edu/~rtp1/PrinciplesPlanetaryClimate/index.html">2010</a>).</p><p>The total upward-directed energy flux <span>$F_{i}$</span> describes the total upward-directed energy transport (units of <span>$\text{W m}^{-2}$</span>) from cell <span>$i$</span> into cell <span>$i-1$</span> above (or into space for <span>$i=1$</span>). For energy to be conserved throughout the column, it must be true that <span>$F_i = F_t \text{ } \forall \text{ } i$</span> where <span>$F_t$</span> is the total amount of energy being transported out of the planet. In global radiative equilibrium, <span>$F_t = 0$</span>.</p><h3 id="Definition-of-residuals"><a class="docs-heading-anchor" href="#Definition-of-residuals">Definition of residuals</a><a id="Definition-of-residuals-1"></a><a class="docs-heading-anchor-permalink" href="#Definition-of-residuals" title="Permalink"></a></h3><p>We can use this construction to solve for the temperature profile of the atmosphere as an <span>$N+1$</span>-dimensional optimisation problem. This directly solves for <span>$T(p)$</span> at radiative-convective equilibrium without having to invoke heating rate calculations, thereby avoiding slow convergence in regions of the atmosphere with long radiative timescales. The residuals vector (length <span>$N+1$</span>)</p><p class="math-container">\[
\bm{r} =

\begin{pmatrix}
r_i     \\
r_{i+1} \\
...     \\
r_N     \\
r_{N+1}
\end{pmatrix}

=

\begin{pmatrix}
F_{i+1} - F_i     \\
F_{i+2} - F_{i+1} \\
...     \\
F_{N+1} - F_N     \\
F_{N+1} - F_t
\end{pmatrix}\]</p><p>is what we aim to minimise as our &#39;objective function&#39;, subject to the solution vector of cell-centre temperatures</p><p class="math-container">\[\bm{x} =

\begin{pmatrix}
T_i     \\
T_{i+1} \\
...     \\
T_N     \\
T_s
\end{pmatrix}\]</p><p>where <span>$T_s$</span> is the surface temperature. Cell-edge temperatures in the bulk atmosphere are interpolated from cell-centres. The bottom- and top-most cell edge temperatures are extrapolated by estimation of <span>$dT/d \log p$</span>. Cell properties (heat capacity, gravity, density, average molecular weight, etc.) are consistently updated at each evaluation of <span>$\bm{r}$</span>. Condensation/rainout are also handled at each evaluation of <span>$\bm{r}$</span> in order to avoid supersaturation.</p><p>The model converges when the cost function <span>$c(\bm{x}) = \sqrt{\sum_i |r_i|}$</span> satisfies the condition</p><p class="math-container">\[c(\bm{x}) &lt; c_a + c_r \cdot \underset{i}{\max} \text{ } |F_i|\]</p><p>which represents a state where the fluxes are sufficiently conserved. The quantities <span>$c_a$</span> and <span>$c_r$</span> are the absolute and relative tolerances provided by the user (parameters <code>conv_atol</code> and <code>conv_rtol</code> in <code>solver.solve_energy!()</code>).</p><h3 id="Iterative-steps"><a class="docs-heading-anchor" href="#Iterative-steps">Iterative steps</a><a id="Iterative-steps-1"></a><a class="docs-heading-anchor-permalink" href="#Iterative-steps" title="Permalink"></a></h3><p>The model solves for <span>$\bm{x}$</span> iteratively, starting from some initial guess. The initial guess should be any reasonable temperature profile which is not significantly cooler than the expected solution. The flowchart below broadly outlines the solution process.</p>  <img src="assets/model_flowchart.svg" width=50% class="center"/><p>The Jacobian matrix <span>$\bm{J}$</span> represents the directional gradient of the residuals with respect to the solution vector. It is a square matrix with elements set according to</p><p class="math-container">\[J_{uv} = \frac{\partial r_u}{\partial x_v}\]</p><p>AGNI estimates <span>$\bm{J}$</span> using finite-differences, requiring <span>$N+1$</span> evalulations of <span>$\bm{r}$</span> in order to fill the matrix. This corresponds to <span>$2(N+1)+1$</span> objective function calculations under a 2nd order central-difference scheme. Each level <span>$v$</span> with temperature <span>$x_v$</span> is perturbed by an amount <span>$\pm \varepsilon x_v$</span> in order to fill a single column of <span>$\bm{J}$</span>. As such, it can be expensive to construct a full Jacobian, especially when it is discarded at the end of each iteration. To reduce the total number of calculations, AGNI retains some of the columns in <span>$\bm{J}$</span> between model iterations. This assumes that the second derivative of the residuals is small. A column <span>$v$</span> is retained only when</p><p class="math-container">\[\max |r_i| \lt 0.7 \text{ for } i \in \{v-1, v, v+1\}\]</p><p>and when <span>$c(\bm{x})/10$</span> does <strong>not</strong> satisfy the convergence criteria.</p><p>With a Jacobian constructed, we can calculate an update <span>$\bm{d}$</span> to the solution vector <span>$\bm{x} \rightarrow \bm{x} + \bm{d}$</span>. This is primarily done via the Newton-Raphson method</p><p class="math-container">\[\bm{d} = -\bm{J}^{-1} \bm{r}\]</p><p>but can alternatively be performed via the Gauss-Newton and Levenberg–Marquardt methods.</p><p>It is possible for the model to become stuck in a local minimum, leading to very small values of <span>$|\bm{d}|$</span>. This is identified when <span>$c(\bm{x})$</span> has seen little change over the last few iterations. When this occurs, the model is &#39;nudged&#39; by scaling the update via</p><p class="math-container">\[\bm{d} \rightarrow 3 \bm{d}\]</p><p>In many cases <span>$\bm{d}$</span> is too large, leading to instabilities. This is due to the non-convexity of the solution space, and the somewhat discontinuous nature of the physics involved (particularly in its temperature derivatives). When <span>$|\bm{d}|&gt;d_{\text{max}}$</span>, the update is crudely scaled via</p><p class="math-container">\[\bm{d} \rightarrow  d_{\text{max}} \hat{\bm{d}}\]</p><p>The update may also be scaled by a linesearch</p><p class="math-container">\[\bm{d} \rightarrow \alpha \bm{d}\]</p><p>on <span>$\alpha$</span>. This is applied if the full step <span>$\bm{d}$</span> would increase the cost by an unacceptable amount. If the model is close to convergence then a golden-section search method is used to determine the optimal <span>$\alpha$</span>, otherwise a backtracking method is used.  This means that the model is (mostly) able to avoid oscillating around a solution. All three of these scalings to <span>$\bm{d}$</span> preserve its direction.</p><h2 id="Other-features"><a class="docs-heading-anchor" href="#Other-features">Other features</a><a id="Other-features-1"></a><a class="docs-heading-anchor-permalink" href="#Other-features" title="Permalink"></a></h2><p>AGNI can calculate emission spectra, provided with T(p) and the volume mixing ratios of the gases. This is performed using the same RT as the RCE calculations, so is limited in resolution by the choice of correlated-k bands. Similarly, the longwave contribution function can also be calculated.</p><h2 id="Julia-and-Fortran"><a class="docs-heading-anchor" href="#Julia-and-Fortran">Julia and Fortran</a><a id="Julia-and-Fortran-1"></a><a class="docs-heading-anchor-permalink" href="#Julia-and-Fortran" title="Permalink"></a></h2><p>AGNI is primarily written in Julia, while SOCRATES itself is written in Fortran. Julia was chosen because it allows the SOCRATES binaries to be included in the precompiled code, which significantly improves performance.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><a class="docs-footer-nextpage" href="../setup/">Getting started »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.15.0 on <span class="colophon-date" title="Wednesday 12 November 2025 15:48">Wednesday 12 November 2025</span>. Using Julia version 1.11.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
